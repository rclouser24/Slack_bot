const https = require('https');

exports.handler = async (event) => {
    // Extract the city from the event payload
    const city = event.city;
    if (!city) {
        throw new Error('City not provided');
    }

    // Get the API key from environment variables
    const apiKey = process.env.WEATHER_API_KEY;
    const url = `http://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}`;

    // Make the HTTP request to the OpenWeatherMap API
    const response = await new Promise((resolve, reject) => {
        https.get(url, (res) => {
            let data = '';
            res.on('data', (chunk) => {
                data += chunk;
            });
            res.on('end', () => {
                try {
                    const json = JSON.parse(data);
                    // Check if the API returned an error
                    if (json.cod !== 200) {
                        reject(new Error(`API error: ${json.message}`));
                    } else {
                        resolve(json);
                    }
                } catch (err) {
                    reject(err);
                }
            });
        }).on('error', (err) => {
            reject(err);
        });
    });

    // Extract temperature and convert from Kelvin to Celsius
    const temperature = response.main.temp;
    const temperatureCelsius = temperature - 273.15;
    console.log(`The temperature in ${city} is ${temperatureCelsius.toFixed(2)}Â°C`);
};